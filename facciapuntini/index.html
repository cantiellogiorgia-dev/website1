<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>P5.js Image to Blue Dots</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            background: #000; 
            overflow: hidden;
        }
        canvas {
            display: block;
            box-shadow: 0 0 20px rgba(0,0,255,0.2);
        }
    </style>
</head>
<body>

<script>
let img;
let puntoDim = 2; 
let spaziatura = 2; 

function preload() {
    // IMPORTANTE: Assicurati che l'estensione (.png, .jpg) sia corretta
    // Se l'immagine è nella cartella img che sta un livello sopra:
    img = loadImage('../img/r.png', 
        () => console.log("Immagine caricata!"), 
        () => console.error("Errore: Immagine non trovata. Controlla il percorso.")
    ); 
}

function setup() {
    // Se l'immagine non viene caricata, creiamo un canvas di default per non bloccare tutto
    let canvasW = img ? img.width : 400;
    let canvasH = img ? img.height : 400;
    createCanvas(canvasW, canvasH);
    noLoop(); 
}

function draw() {
    background(0); 
    
    if (!img) {
        fill(255);
        textAlign(CENTER);
        text("Caricamento immagine fallito.\nControlla la console (F12).", width/2, height/2);
        return;
    }

    img.loadPixels();
    let step = puntoDim + spaziatura;

    // Ciclo ottimizzato usando l'array pixels
    for (let y = 0; y < img.height; y += step) {
        for (let x = 0; x < img.width; x += step) {
            
            // Calcolo dell'indice del pixel (r, g, b, a)
            let i = (x + y * img.width) * 4;
            
            let r = img.pixels[i];
            let g = img.pixels[i+1];
            let b = img.pixels[i+2];
            let a = img.pixels[i+3];

            if (a > 50) { // Soglia di trasparenza
                // Calcoliamo la luminosità media
                let luminosita = (r + g + b) / 3;
                
                // Effetto monocromatico blu: (0, 0, intensità, opacità)
                fill(0, 0, luminosita, a);
                noStroke();
                
                // Disegna il pixel quadrato
                rect(x, y, puntoDim, puntoDim);
            }
        }
    }
}
</script>

</body>
</html>